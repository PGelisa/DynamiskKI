import React, { useState, useEffect, useRef } from 'react';
import { Wind, MoveRight, ArrowDownToLine, Info, Waves, Eye, EyeOff } from 'lucide-react';

const WaveSimulation = () => {
  // State for simuleringen
  const [depth, setDepth] = useState(50); // 0 = Veldig grunt, 100 = Dypt
  const [wind, setWind] = useState(30);   // Påvirker amplitude og overflatedrift
  const [current, setCurrent] = useState(0); // Global strøm
  const [showOrbits, setShowOrbits] = useState(true);
  const [isPlaying, setIsPlaying] = useState(true);

  const canvasRef = useRef(null);
  const requestRef = useRef();
  const timeRef = useRef(0);
  
  // Partikler
  const particlesRef = useRef([]);
  const numCols = 20;
  const numRows = 10;

  // Initialiser partikler
  useEffect(() => {
    const particles = [];
    for (let i = 0; i < numCols; i++) {
      for (let j = 0; j < numRows; j++) {
        particles.push({
          ix: i, // Grid indekser
          iy: j,
          x: 0,  // Faktisk posisjon
          y: 0,
          baseX: 0, // "Hjem"-posisjon før bølgebevegelse
          baseY: 0
        });
      }
    }
    particlesRef.current = particles;
  }, []);

  // Animasjonsløkke
  const animate = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    const width = canvas.width;
    const height = canvas.height;

    // Fysikk-konstanter avledet fra state
    const waveLength = width / 3; 
    const k = (2 * Math.PI) / waveLength; // Bølgetall
    const speed = 0.05 + (wind * 0.001); // Bølgefart
    const amplitudeBase = 10 + (wind * 0.5); // Bølgehøyde
    
    // Konverter dybde-slider (0-100) til en faktor.
    // Ved dypt vann (100), avtar bevegelsen eksponentielt nedover.
    // Ved grunt vann (0), er bevegelsen elliptisk og mer uniform horisontalt.
    const isShallow = depth < 40;
    const depthFactor = depth / 100; 
    
    // Juster havnivå basert på dybde
    const seaFloorY = height - (height * 0.2 * (depth / 100)) - 50;
    const surfaceY = height * 0.3;
    const waterDepthPixels = seaFloorY - surfaceY;

    // Oppdater tid
    if (isPlaying) {
      timeRef.current += speed;
    }
    const t = timeRef.current;

    // Tegn bakgrunn (Himmel)
    const skyGradient = ctx.createLinearGradient(0, 0, 0, surfaceY);
    skyGradient.addColorStop(0, '#e0f7fa');
    skyGradient.addColorStop(1, '#b2ebf2');
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, width, height);

    // Tegn Vann
    const waterGradient = ctx.createLinearGradient(0, surfaceY, 0, height);
    waterGradient.addColorStop(0, '#4fc3f7');
    waterGradient.addColorStop(1, '#01579b');
    ctx.fillStyle = waterGradient;
    ctx.beginPath();
    ctx.moveTo(0, surfaceY);
    
    // Tegn overflatebølgen
    for (let x = 0; x <= width; x += 10) {
      const y = surfaceY + Math.sin(x * k - t * 5) * amplitudeBase;
      ctx.lineTo(x, y);
    }
    ctx.lineTo(width, height);
    ctx.lineTo(0, height);
    ctx.fill();

    // Tegn bunnen
    ctx.fillStyle = '#d7ccc8'; // Sandfarge
    ctx.fillRect(0, seaFloorY, width, height - seaFloorY);
    
    // Tegn tekstur på bunnen
    ctx.strokeStyle = '#a1887f';
    ctx.beginPath();
    for(let x = 0; x < width; x+=20) {
        ctx.moveTo(x, seaFloorY);
        ctx.lineTo(x + 10, height);
    }
    ctx.stroke();

    // --- PARTIKKEL LOGIKK ---
    const gridWidth = width * 1.2; // Litt bredere for å håndtere scrolling
    const colSpacing = gridWidth / numCols;
    const rowSpacing = waterDepthPixels / (numRows + 1);

    // Havstrøm forskyvning (kontinuerlig drift)
    // Vi bruker modulus for å holde partiklene innenfor skjermen visuelt for "basen"
    const currentDrift = (current * t) * 2; 

    particlesRef.current.forEach((p) => {
      // Beregn "Hjem"-posisjon
      // Vi legger til drift fra havstrøm her
      let driftX = (p.ix * colSpacing) + currentDrift;
      
      // Wrap-around logikk for strøm
      driftX = driftX % gridWidth;
      if (driftX < -50) driftX += gridWidth;

      p.baseX = driftX - 50; // Offset for å starte litt utenfor skjermen
      p.baseY = surfaceY + (p.iy + 1) * rowSpacing;

      // Avstand fra overflaten (normalisert 0 til 1)
      const depthRatio = (p.baseY - surfaceY) / waterDepthPixels; 
      // Invers dybde (1 på overflaten, 0 på bunnen)
      const z = 1 - depthRatio; 

      // --- FYSIKK BEREGNINGER ---
      let radiusX, radiusY;

      if (depth > 60) {
        // DYPT VANN TEORI
        // Banene er sirkulære: Rx = Ry
        // Radius avtar eksponentielt med dybden: e^(-kz)
        // Vi faker eksponenten litt for visuell klarhet
        const decay = Math.exp(-depthRatio * 3); 
        radiusX = amplitudeBase * decay;
        radiusY = amplitudeBase * decay;
      } else {
        // GRUNT VANN TEORI
        // Banene er ellipser.
        // Horisontal bevegelse (Rx) er nesten konstant helt til bunnen.
        // Vertikal bevegelse (Ry) går mot null ved bunnen (lineært).
        radiusX = amplitudeBase * (1 - depthRatio * 0.2); // Mister litt kraft nedover
        radiusY = amplitudeBase * z; // Går mot 0 på bunnen
      }

      // Legg til litt ekstra drift på overflaten hvis det er vind (Stokes drift simulering)
      // Dette er bare en visuell effekt som skyver "fasen" litt
      const windPhaseShift = (wind / 100) * z * t;

      const phase = k * p.baseX - t * 5;
      
      // Partikkelens posisjon i banen
      const orbitalX = -Math.sin(phase) * radiusX;
      const orbitalY = Math.cos(phase) * radiusY;

      p.x = p.baseX + orbitalX + (windPhaseShift * 10); // Legg til litt vind-drift i posisjon
      p.y = p.baseY + orbitalY;

      // Hvis partikkelen er under havbunnen, klem den opp (edge case fix)
      if (p.y > seaFloorY) p.y = seaFloorY;

      // TEGNING
      
      // 1. Tegn Banen (Orbit)
      if (showOrbits) {
        ctx.beginPath();
        ctx.ellipse(p.baseX + (windPhaseShift * 10), p.baseY, Math.abs(radiusX), Math.abs(radiusY), 0, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      // 2. Tegn Partikkelen
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
      // Farge basert på dybde for visuell effekt
      ctx.fillStyle = `rgba(255, 255, 255, ${0.5 + z * 0.5})`; 
      ctx.fill();
    });

    // Tegn piler for vind og strøm
    drawArrows(ctx, width, surfaceY);

    requestRef.current = requestAnimationFrame(animate);
  };

  const drawArrows = (ctx, width, surfaceY) => {
    // Vindpil
    if (wind > 0) {
      const arrowLength = wind * 2;
      ctx.save();
      ctx.translate(width / 2, 50);
      ctx.fillStyle = '#ef4444';
      ctx.font = '14px sans-serif';
      ctx.fillText(`Vindstress (${wind}%)`, -40, -10);
      
      ctx.beginPath();
      ctx.moveTo(-arrowLength/2, 0);
      ctx.lineTo(arrowLength/2, 0);
      ctx.lineTo(arrowLength/2 - 10, -5);
      ctx.lineTo(arrowLength/2 - 10, 5);
      ctx.lineTo(arrowLength/2, 0);
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.restore();
    }

    // Strømpil
    if (Math.abs(current) > 0) {
      const arrowLength = current * 3;
      ctx.save();
      ctx.translate(width / 2, surfaceY + 100);
      ctx.fillStyle = '#10b981';
      ctx.font = '14px sans-serif';
      ctx.fillText(`Havstrøm`, -30, -10);

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(arrowLength, 0);
      // Pilhode retning
      const dir = current > 0 ? 1 : -1;
      ctx.lineTo(arrowLength - (10 * dir), -5);
      ctx.lineTo(arrowLength - (10 * dir), 5);
      ctx.lineTo(arrowLength, 0);
      
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.restore();
    }
  };

  useEffect(() => {
    requestRef.current = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(requestRef.current);
  }, [depth, wind, current, showOrbits, isPlaying]);

  // Håndtere resize
  useEffect(() => {
    const handleResize = () => {
        if(canvasRef.current) {
            canvasRef.current.width = canvasRef.current.parentElement.clientWidth;
            canvasRef.current.height = 400;
        }
    }
    window.addEventListener('resize', handleResize);
    handleResize();
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return (
    <div className="flex flex-col w-full max-w-4xl mx-auto p-4 bg-slate-50 rounded-xl shadow-lg gap-6 font-sans">
      
      <div className="text-center mb-2">
        <h1 className="text-2xl font-bold text-slate-800">Partikkelbevegelse i Vannbølger</h1>
        <p className="text-slate-600">Interaktiv simulator av dypvanns- og grunnvannsbølger</p>
      </div>

      {/* Canvas Container */}
      <div className="relative w-full h-[400px] bg-blue-100 rounded-lg overflow-hidden shadow-inner border border-blue-200">
        <canvas ref={canvasRef} className="w-full h-full block" />
        
        {/* Overlay info box based on physics state */}
        <div className="absolute top-4 left-4 bg-white/90 backdrop-blur p-3 rounded-lg shadow text-sm max-w-[200px]">
          <div className="flex items-center gap-2 font-bold text-slate-700 mb-1">
            <Info size={16} />
            Status: {depth > 60 ? "Dypt Vann" : (depth < 30 ? "Grunt Vann" : "Overgangssone")}
          </div>
          <p className="text-slate-600 text-xs leading-relaxed">
            {depth > 60 
              ? "Partiklene beveger seg i sirkulære baner. Radiusen avtar raskt med dybden."
              : "Partikkelbanene blir flate ellipser. Nær bunnen er bevegelsen kun frem og tilbake."}
          </p>
        </div>
      </div>

      {/* Controls Panel */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        
        {/* Left Column: Sliders */}
        <div className="space-y-6">
          
          {/* Dybde Slider */}
          <div>
            <div className="flex justify-between items-center mb-2">
              <label className="flex items-center gap-2 font-semibold text-slate-700">
                <ArrowDownToLine size={18} className="text-blue-600"/>
                Dybde
              </label>
              <span className="text-xs font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded">
                {depth > 60 ? "Dypt" : "Grunt"} ({depth}m)
              </span>
            </div>
            <input 
              type="range" min="10" max="100" value={depth} 
              onChange={(e) => setDepth(parseInt(e.target.value))}
              className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
            />
            <div className="flex justify-between text-xs text-slate-400 mt-1">
              <span>Grunt (Ellipser)</span>
              <span>Dypt (Sirkler)</span>
            </div>
          </div>

          {/* Vind Slider */}
          <div>
            <div className="flex justify-between items-center mb-2">
              <label className="flex items-center gap-2 font-semibold text-slate-700">
                <Wind size={18} className="text-red-500"/>
                Vindstress
              </label>
              <span className="text-xs font-mono bg-red-100 text-red-800 px-2 py-1 rounded">
                {wind}%
              </span>
            </div>
            <input 
              type="range" min="0" max="100" value={wind} 
              onChange={(e) => setWind(parseInt(e.target.value))}
              className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500"
            />
          </div>

          {/* Strøm Slider */}
          <div>
            <div className="flex justify-between items-center mb-2">
              <label className="flex items-center gap-2 font-semibold text-slate-700">
                <MoveRight size={18} className="text-emerald-500"/>
                Havstrøm
              </label>
              <span className="text-xs font-mono bg-emerald-100 text-emerald-800 px-2 py-1 rounded">
                {current > 0 ? "Mot Høyre" : (current < 0 ? "Mot Venstre" : "Ingen")}
              </span>
            </div>
            <input 
              type="range" min="-20" max="20" value={current} 
              onChange={(e) => setCurrent(parseInt(e.target.value))}
              className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-500"
            />
          </div>

        </div>

        {/* Right Column: Toggles & Info */}
        <div className="flex flex-col justify-between border-l border-slate-100 pl-0 md:pl-6">
          
          <div className="space-y-4">
            <button 
              onClick={() => setShowOrbits(!showOrbits)}
              className={`w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg border transition-colors ${showOrbits ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}
            >
              {showOrbits ? <Eye size={18}/> : <EyeOff size={18}/>}
              {showOrbits ? "Skjul Baner (Orbitaler)" : "Vis Baner (Orbitaler)"}
            </button>

            <button 
              onClick={() => setIsPlaying(!isPlaying)}
              className="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-slate-800 text-white hover:bg-slate-900 transition-colors"
            >
              <Waves size={18}/>
              {isPlaying ? "Pause Animasjon" : "Start Animasjon"}
            </button>
          </div>

          <div className="mt-6 bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-sm text-yellow-800">
            <h3 className="font-bold mb-1 flex items-center gap-2">
               Kort forklart:
            </h3>
            <ul className="list-disc pl-4 space-y-1 opacity-90 text-xs">
              <li><strong>Dypt vann:</strong> Vannpartiklene beveger seg i sirkler. Radien på sirkelen halveres for hver 1/9 av bølgelengden man går nedover.</li>
              <li><strong>Grunt vann:</strong> Bunnen presser sirkelbevegelsen flat. Partiklene beveger seg i ellipser. Helt ved bunnen beveger vannet seg bare frem og tilbake.</li>
            </ul>
          </div>

        </div>
      </div>
    </div>
  );
};

export default WaveSimulation;
